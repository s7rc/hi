import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Canvas;
import android.util.AttributeSet;
import android.view.MotionEvent;
import android.view.View;

public class JoystickView extends View {

    private Bitmap mBaseBitmap;
    private Bitmap mStickBitmap;
    
    private float mCenterX;
    private float mCenterY;
    private float mStickX;
    private float mStickY;
    
    // The radius within which the stick can move (usually half the base width)
    private float mMaxRadius;
    
    private JoystickListener mListener;

    public interface JoystickListener {
        void onJoystickMoved(float xPercent, float yPercent);
    }

    public JoystickView(Context context, AttributeSet attrs) {
        super(context, attrs);
        init(context);
    }

    private void init(Context context) {
        // Load your images here (or pass them in)
        // These match the files: ic_controller_analog_base.png, ic_controller_analog_stick.png
        mBaseBitmap = BitmapFactory.decodeResource(getResources(), R.drawable.ic_controller_analog_base);
        mStickBitmap = BitmapFactory.decodeResource(getResources(), R.drawable.ic_controller_analog_stick);
        
        // Calculate radius based on the background image size
        mMaxRadius = mBaseBitmap.getWidth() / 2.0f;
    }

    @Override
    protected void onSizeChanged(int w, int h, int oldw, int oldh) {
        super.onSizeChanged(w, h, oldw, oldh);
        // Position the joystick in the center of the view
        mCenterX = w / 2.0f;
        mCenterY = h / 2.0f;
        
        // Initial stick position is the center
        mStickX = mCenterX;
        mStickY = mCenterY;
    }

    @Override
    protected void onDraw(Canvas canvas) {
        super.onDraw(canvas);
        
        // 1. Draw the Base (centered)
        if (mBaseBitmap != null) {
            canvas.drawBitmap(mBaseBitmap, 
                mCenterX - mBaseBitmap.getWidth() / 2f, 
                mCenterY - mBaseBitmap.getHeight() / 2f, 
                null);
        }

        // 2. Draw the Stick (at calculated position)
        if (mStickBitmap != null) {
            canvas.drawBitmap(mStickBitmap, 
                mStickX - mStickBitmap.getWidth() / 2f, 
                mStickY - mStickBitmap.getHeight() / 2f, 
                null);
        }
    }

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        float x = event.getX();
        float y = event.getY();

        switch (event.getAction()) {
            case MotionEvent.ACTION_DOWN:
            case MotionEvent.ACTION_MOVE:
                // Calculate the distance from the center
                float dx = x - mCenterX;
                float dy = y - mCenterY;
                float distance = (float) Math.sqrt(dx * dx + dy * dy);

                // LOGIC TO CLAMP THE INNER CIRCLE
                if (distance > mMaxRadius) {
                    // If outside the circle, scale dx/dy down to the edge
                    float scale = mMaxRadius / distance;
                    dx *= scale;
                    dy *= scale;
                }

                // Update stick position
                mStickX = mCenterX + dx;
                mStickY = mCenterY + dy;

                // Send normalized coordinates (-1.0 to 1.0) to your game
                if (mListener != null) {
                    mListener.onJoystickMoved(dx / mMaxRadius, dy / mMaxRadius);
                }
                break;

            case MotionEvent.ACTION_UP:
            case MotionEvent.ACTION_CANCEL:
                // Snap back to center when released
                mStickX = mCenterX;
                mStickY = mCenterY;
                
                if (mListener != null) {
                    mListener.onJoystickMoved(0, 0);
                }
                break;
        }

        // Redraw the view
        invalidate();
        return true;
    }

    public void setJoystickListener(JoystickListener listener) {
        this.mListener = listener;
    }
}